name: Auto Collect RSS News

on:
  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install rss-parser

      - name: Collect RSS feeds
        run: |
          cat > collect-rss.js << 'EOF'
          const Parser = require('rss-parser');
          const fs = require('fs');
          const path = require('path');
          
          const parser = new Parser({
            customFields: {
              item: ['content:encoded', 'content']
            }
          });
          
          // RSSæºé…ç½®
          const feeds = [
            {
              url: 'https://thanhnien.vn/rss/kinh-te.rss',
              source: 'Thanh Nien Kinh Te',
              category: 'market-analysis'
            },
            {
              url: 'https://tuoitre.vn/rss/kinh-doanh.rss', // ä½¿ç”¨Tuoi Treçš„å•†ä¸šç‰ˆå—
              source: 'Tuoi Tre Kinh Doanh',
              category: 'investment-news'
            },
            {
              url: 'https://vietnamnet.vn/kinh-doanh.rss', // ä¿®å¤é‡å®šå‘é—®é¢˜
              source: 'VietnamNet',
              category: 'industry-insights'
            },
            {
              url: 'https://thanhnien.vn/rss/chinh-tri.rss', // æ›´æ”¹ä¸ºæ”¿æ²»ç±»åˆ«ä»¥è·å–æ”¿ç­–ç›¸å…³å†…å®¹
              source: 'Thanh Nien Chinh Tri',
              category: 'vietnam-policy'
            }
          ];
          
          // è¶Šå—æŠ•èµ„ç›¸å…³å…³é”®è¯ - æ‰©å±•å¹¶ä¼˜åŒ–å…³é”®è¯åˆ—è¡¨
          const keywords = [
            // å›½å®¶å’Œè¯­è¨€
            'vietnam', 'viá»‡t nam', 'vietnamese', 'hanoi', 'ho chi minh', 'saigon', 'hochiminh',
            
            // æŠ•èµ„ç›¸å…³
            'investment', 'invest', 'investor', 'investing', 'capital', 'funding', 'venture',
            'Ä‘áº§u tÆ°', 'vá»‘n', 'tÃ i chÃ­nh', 'tÃ­n dá»¥ng', 'cho vay', 'dá»± Ã¡n',
            
            // ç»æµå’Œå¸‚åœº
            'economy', 'economic', 'economist', 'kinh táº¿', 'kinh te', 'gdp', 'inflation', 'growth',
            'market', 'thá»‹ trÆ°á»ng', 'thi truong', 'stock', 'equity', 'trading', 'trade',
            'business', 'doanh nghiá»‡p', 'doanh nghiep', 'company', 'corporate',
            
            // æ”¿ç­–å’Œæ³•è§„
            'policy', 'policies', 'regulation', 'regulatory', 'law', 'legal', 'chÃ­nh sÃ¡ch', 'chinh sach',
            'government', 'governmental', 'state', 'federal', 'central bank', 'ngÃ¢n hÃ ng', 'ngan hang',
            'monetary', 'fiscal', 'tax', 'thuáº¿', 'thue',
            
            // è¡Œä¸šç‰¹å®š
            'bank', 'banking', 'ngÃ¢n hÃ ng', 'ngan hang', 'finance', 'financial',
            'real estate', 'báº¥t Ä‘á»™ng sáº£n', 'bat dong san', 'property', 'housing',
            'technology', 'cÃ´ng nghá»‡', 'cong nghe', 'tech', 'startup', 'innovation',
            'manufacturing', 'manufacture', 'sáº£n xuáº¥t', 'san xuat',
            'export', 'xuáº¥t kháº©u', 'xuat khau', 'import', 'nháº­p kháº©u', 'nhap khau',
            'tourism', 'du lá»‹ch', 'du lich', 'hospitality',
            'agriculture', 'nÃ´ng nghiá»‡p', 'nong nghiep', 'farming',
            
            // ç‰¹å®šæœ¯è¯­
            'FDI', 'foreign direct investment', 'OECD', 'ASEAN', 'APEC', 'TPP', 'RCEP',
            'exchange rate', 'currency', 'dong', 'VNÄ', 'VND',
            'stock exchange', 'stock market', 'HOSE', 'HNX', 'UPCOM'
          ];
          
          // æ£€æŸ¥æ–‡ç« æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
          function isInvestmentRelated(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            return keywords.some(keyword => text.includes(keyword.toLowerCase()));
          }
          
          // ç”Ÿæˆæ–‡ç« slug
          function generateSlug(title) {
            return title
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/[\s_-]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 50);
          }
          
          // è·å–åˆ†ç±»æ ‡ç­¾
          function getCategoryTags(category) {
            const tagMap = {
              'vietnam-policy': ['vietnam', 'policy', 'government', 'regulation'],
              'market-analysis': ['market', 'analysis', 'economy', 'trend'],
              'investment-news': ['investment', 'finance', 'funding', 'capital'],
              'industry-insights': ['industry', 'business', 'innovation', 'growth']
            };
            return tagMap[category] || ['vietnam', 'news'];
          }
          
          // ç”ŸæˆMarkdownå†…å®¹
          function generateMarkdownContent(item, feedSource, category) {
            const date = new Date();
            const slug = generateSlug(item.title);
            const timePart = `${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}${String(date.getSeconds()).padStart(2,'0')}`;
            const filename = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}-${timePart}-${slug}.md`;
            
            const tags = getCategoryTags(category);
            const content = item['content:encoded'] || item.content || item.contentSnippet || '';
            const cleanContent = content.replace(/<[^>]*>/g, '').substring(0, 500);
            
            const markdownContent = `---
layout: post
title: "${item.title.replace(/"/g, '\\"')}"
date: ${date.toISOString().replace('T', ' ').replace(/\.\d{3}Z/, ' +0700')}
category: ${category}
tags: ${JSON.stringify(tags)}
source_url: "${item.link}"
author: "seacall Team"
excerpt: "${cleanContent.replace(/"/g, '\\"')}..."
featured: false
keywords: "${tags.join(', ')}"
---

## æ–°é—»æ‘˜è¦

${cleanContent}

## æŠ•èµ„è§’åº¦åˆ†æ

### ğŸ“Š å¸‚åœºå½±å“
æ ¹æ®è¿™ä¸€æ–°é—»ï¼Œå¯èƒ½å¯¹ç›¸å…³å¸‚åœºäº§ç”Ÿä»¥ä¸‹å½±å“ï¼š
- **çŸ­æœŸå½±å“**ï¼šå¸‚åœºæƒ…ç»ªå˜åŒ–ï¼Œç›¸å…³è‚¡ç¥¨æ³¢åŠ¨
- **ä¸­æœŸå½±å“**ï¼šè¡Œä¸šæ”¿ç­–è°ƒæ•´ï¼ŒæŠ•èµ„æœºä¼šæ¶Œç°
- **é•¿æœŸå½±å“**ï¼šç»“æ„æ€§å˜åŒ–ï¼Œäº§ä¸šæ ¼å±€é‡å¡‘

### ğŸ’¡ æŠ•èµ„æœºä¼š
åŸºäºæ–°é—»å†…å®¹ï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºä»¥ä¸‹æ½œåœ¨æŠ•èµ„æœºä¼šï¼š
- **ç›´æ¥æœºä¼š**ï¼šç›¸å…³ä¸Šå¸‚å…¬å¸ã€è¡Œä¸šé¾™å¤´
- **é—´æ¥æœºä¼š**ï¼šä¾›åº”é“¾ä¼ä¸šã€é…å¥—æœåŠ¡å•†
- **æ–°å…´æœºä¼š**ï¼šæŠ€æœ¯åˆ›æ–°ã€å•†ä¸šæ¨¡å¼å˜åŒ–

### âš ï¸ é£é™©æç¤º
æŠ•èµ„è€…éœ€è¦æ³¨æ„çš„é£é™©å› ç´ ï¼š
- **æ”¿ç­–é£é™©**ï¼šæ”¿åºœæ”¿ç­–å˜åŒ–çš„ä¸ç¡®å®šæ€§
- **å¸‚åœºé£é™©**ï¼šå¸‚åœºæ³¢åŠ¨å’Œç«äº‰åŠ å‰§
- **æ“ä½œé£é™©**ï¼šæŠ•èµ„æ—¶æœºå’Œè§„æ¨¡æ§åˆ¶

## ç›¸å…³èµ„æº

- **åŸæ–‡é“¾æ¥**ï¼š[æŸ¥çœ‹å®Œæ•´æ–°é—»](${item.link})
- **æ–°é—»æ¥æº**ï¼š${feedSource}
- **å‘å¸ƒæ—¶é—´**ï¼š${new Date(item.pubDate || date).toLocaleDateString('zh-CN')}

> **æŠ•èµ„å»ºè®®**ï¼šä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„å†³ç­–éœ€è¦ç»¼åˆè€ƒè™‘ä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›å’ŒæŠ•èµ„ç›®æ ‡ã€‚å»ºè®®å’¨è¯¢ä¸“ä¸šæŠ•èµ„é¡¾é—®ã€‚

*æƒ³è¦è·å–æ›´ä¸“ä¸šçš„æŠ•èµ„åˆ†æå’Œå»ºè®®ï¼Ÿç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä½“éªŒseacall AIæŠ•èµ„é¡¾é—®æœåŠ¡ã€‚*
`;
            
            return { filename, content: markdownContent };
          }
          
          async function collectNews() {
            console.log('å¼€å§‹é‡‡é›†RSSæ–°é—»...');
            let totalCollected = 0;
            let totalSkipped = 0;
            
            for (const feed of feeds) {
              try {
                console.log(`æ­£åœ¨é‡‡é›†: ${feed.url} (${feed.source})`);
                const parsed = await parser.parseURL(feed.url);
                console.log(`æˆåŠŸè·å–RSSæº: ${feed.url}, æ–‡ç« æ•°é‡: ${parsed.items.length}`);
                
                // å¢åŠ åˆ°æ¯ä¸ªæºæœ€å¤šå–5ç¯‡
                const items = parsed.items.slice(0, 5);
                let feedCollected = 0;
                let feedSkipped = 0;
                
                for (const item of items) {
                  try {
                    // æ£€æŸ¥æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
                    if (isInvestmentRelated(item.title, item['content:encoded'] || item.content || item.contentSnippet || '')) {
                      const { filename, content } = generateMarkdownContent(item, feed.source, feed.category);
                      const filePath = path.join('_posts', filename);
                      
                      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                      if (!fs.existsSync(filePath)) {
                        fs.writeFileSync(filePath, content, 'utf8');
                        console.log(`âœ… å·²åˆ›å»º: ${filename}`);
                        feedCollected++;
                        totalCollected++;
                      } else {
                        console.log(`â„¹ï¸ å·²å­˜åœ¨: ${filename}`);
                        feedSkipped++;
                        totalSkipped++;
                      }
                    } else {
                      console.log(`â­ï¸ è·³è¿‡ä¸ç›¸å…³æ–‡ç« : ${item.title.substring(0, 50)}...`);
                      feedSkipped++;
                      totalSkipped++;
                    }
                  } catch (itemError) {
                    console.error(`âŒ å¤„ç†æ–‡ç« æ—¶å‡ºé”™: ${item.title}`, itemError.message);
                    feedSkipped++;
                    totalSkipped++;
                  }
                }
                
                console.log(`ğŸ“Š ${feed.source} é‡‡é›†å®Œæˆ: æ–°å¢ ${feedCollected} ç¯‡, è·³è¿‡ ${feedSkipped} ç¯‡`);
              } catch (error) {
                console.error(`âŒ é‡‡é›† ${feed.url} æ—¶å‡ºé”™:`, error.message);
              }
            }
            
            console.log(`ğŸ‰ RSSé‡‡é›†å®Œæˆ: æ€»è®¡æ–°å¢ ${totalCollected} ç¯‡, è·³è¿‡ ${totalSkipped} ç¯‡`);
          }
          
          collectNews().catch(console.error);
          EOF
          
          node collect-rss.js

      - name: Commit new posts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _posts/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto: Add RSS news posts [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æ–°æ–‡ç« å·²è‡ªåŠ¨å‘å¸ƒ"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ–‡ç« éœ€è¦å‘å¸ƒ"
          fi

      - name: Create summary
        run: |
          echo "## RSS Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Executed at (UTC): $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- New posts: $(git diff HEAD~1 --name-only --diff-filter=A | grep '^_posts/' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Site: https://news.seacall.com" >> $GITHUB_STEP_SUMMARY