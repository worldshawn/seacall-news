name: Auto Collect RSS News

on:
  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install rss-parser axios entities

      - name: Collect RSS feeds
        env:
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        run: |
          cat > collect-rss.js << 'EOF'
          const Parser = require('rss-parser');
          const fs = require('fs');
          const path = require('path');
          const axios = require('axios');
          const { decode } = require('entities');
          
          const parser = new Parser({
            customFields: {
              item: ['content:encoded', 'content']
            },
            requestOptions: {
              headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36'
              },
              timeout: 15000
            }
          });
          
          const QWEN_API_KEY = process.env.QWEN_API_KEY;

          // ä½¿ç”¨é€šä¹‰åƒé—®è¿›è¡Œç¿»è¯‘
          async function translateTextWithQwen(text) {
            if (!QWEN_API_KEY || !text || !text.trim()) {
              if (!QWEN_API_KEY) console.log('Qwen: API Key æœªé…ç½®ï¼Œè·³è¿‡ç¿»è¯‘ã€‚');
              return null;
            }
            
            const url = 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation';
            const payload = {
              model: 'qwen-mt-plus',
              input: {
                messages: [
                  {
                    role: 'user',
                    content: text.substring(0, 2000)
                  }
                ]
              },
              parameters: {
                result_format: 'message',
                translation_options: {
                  source_lang: 'Vietnamese',
                  target_lang: 'Chinese'
                }
              }
            };

            try {
              console.log(`Qwen: å‡†å¤‡ç¿»è¯‘ -> "${text.substring(0, 50)}..."`);
              const resp = await axios.post(url, payload, {
                headers: {
                  'Authorization': `Bearer ${QWEN_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                timeout: 45000
              });

              if (resp.data && resp.data.output && resp.data.output.choices && resp.data.output.choices.length > 0) {
                const translatedText = resp.data.output.choices[0].message.content;
                if (translatedText && translatedText.trim()) {
                  return translatedText.trim();
                }
              }
              console.error('Qwen ç¿»è¯‘å¤±è´¥: å“åº”æ ¼å¼ä¸æ­£ç¡®', JSON.stringify(resp.data));
              return null;
            } catch (e) {
              console.error('Qwen ç¿»è¯‘å¤±è´¥:', e.response?.status, e.message);
              if (e.response?.data) console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(e.response.data));
              return null;
            }
          }
          
          // RSSæºé…ç½®
          const feeds = [
            {
              url: 'https://thanhnien.vn/rss/kinh-te.rss',
              source: 'Thanh Nien Kinh Te',
              category: 'market-analysis'
            },
            {
              url: 'https://tuoitre.vn/rss/kinh-doanh.rss', // ä½¿ç”¨Tuoi Treçš„å•†ä¸šç‰ˆå—
              source: 'Tuoi Tre Kinh Doanh',
              category: 'investment-news'
            },
            {
              url: 'https://vietnamnet.vn/kinh-doanh.rss', // ä¿®å¤é‡å®šå‘é—®é¢˜
              source: 'VietnamNet',
              category: 'industry-insights'
            },
            {
              url: 'https://thanhnien.vn/rss/chinh-tri.rss', // æ›´æ”¹ä¸ºæ”¿æ²»ç±»åˆ«ä»¥è·å–æ”¿ç­–ç›¸å…³å†…å®¹
              source: 'Thanh Nien Chinh Tri',
              category: 'vietnam-policy'
            }
          ];
          
          // è¶Šå—æŠ•èµ„ç›¸å…³å…³é”®è¯ - æ‰©å±•å¹¶ä¼˜åŒ–å…³é”®è¯åˆ—è¡¨
          const keywords = [
            // å›½å®¶å’Œè¯­è¨€
            'vietnam', 'viá»‡t nam', 'vietnamese', 'hanoi', 'ho chi minh', 'saigon', 'hochiminh',
            
            // æŠ•èµ„ç›¸å…³
            'investment', 'invest', 'investor', 'investing', 'capital', 'funding', 'venture',
            'Ä‘áº§u tÆ°', 'vá»‘n', 'tÃ i chÃ­nh', 'tÃ­n dá»¥ng', 'cho vay', 'dá»± Ã¡n',
            
            // ç»æµå’Œå¸‚åœº
            'economy', 'economic', 'economist', 'kinh táº¿', 'kinh te', 'gdp', 'inflation', 'growth',
            'market', 'thá»‹ trÆ°á»ng', 'thi truong', 'stock', 'equity', 'trading', 'trade',
            'business', 'doanh nghiá»‡p', 'doanh nghiep', 'company', 'corporate',
            
            // æ”¿ç­–å’Œæ³•è§„
            'policy', 'policies', 'regulation', 'regulatory', 'law', 'legal', 'chÃ­nh sÃ¡ch', 'chinh sach',
            'government', 'governmental', 'state', 'federal', 'central bank', 'ngÃ¢n hÃ ng', 'ngan hang',
            'monetary', 'fiscal', 'tax', 'thuáº¿', 'thue',
            
            // è¡Œä¸šç‰¹å®š
            'bank', 'banking', 'ngÃ¢n hÃ ng', 'ngan hang', 'finance', 'financial',
            'real estate', 'báº¥t Ä‘á»™ng sáº£n', 'bat dong san', 'property', 'housing',
            'technology', 'cÃ´ng nghá»‡', 'cong nghe', 'tech', 'startup', 'innovation',
            'manufacturing', 'manufacture', 'sáº£n xuáº¥t', 'san xuat',
            'export', 'xuáº¥t kháº©u', 'xuat khau', 'import', 'nháº­p kháº©u', 'nhap khau',
            'tourism', 'du lá»‹ch', 'du lich', 'hospitality',
            'agriculture', 'nÃ´ng nghiá»‡p', 'nong nghiep', 'farming',
            
            // ç‰¹å®šæœ¯è¯­
            'FDI', 'foreign direct investment', 'OECD', 'ASEAN', 'APEC', 'TPP', 'RCEP',
            'exchange rate', 'currency', 'dong', 'VNÄ', 'VND',
            'stock exchange', 'stock market', 'HOSE', 'HNX', 'UPCOM'
          ];
          
          // æ£€æŸ¥æ–‡ç« æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
          function isInvestmentRelated(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            return keywords.some(keyword => text.includes(keyword.toLowerCase()));
          }
          
          // ç”Ÿæˆæ–‡ç« slug
          function generateSlug(title) {
            return title
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/[\s_-]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 50);
          }
          
          // è·å–åˆ†ç±»æ ‡ç­¾
          function getCategoryTags(category) {
            const tagMap = {
              'vietnam-policy': ['vietnam', 'policy', 'government', 'regulation'],
              'market-analysis': ['market', 'analysis', 'economy', 'trend'],
              'investment-news': ['investment', 'finance', 'funding', 'capital'],
              'industry-insights': ['industry', 'business', 'innovation', 'growth']
            };
            return tagMap[category] || ['vietnam', 'news'];
          }
          
          // ç”ŸæˆMarkdownå†…å®¹ï¼ˆæ”¯æŒåŒè¯­ï¼‰
          function generateMarkdownContent(item, feedSource, category, zhTitle, zhContent, originalDecodedTitle, originalDecodedContent) {
            const date = new Date();
            const slug = generateSlug(zhTitle || originalDecodedTitle);
            const timePart = String(date.getHours()).padStart(2,'0') + String(date.getMinutes()).padStart(2,'0') + String(date.getSeconds()).padStart(2,'0');
            const filename = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0') + '-' + timePart + '-' + slug + '.md';
            
            const tags = getCategoryTags(category);
            const cleanContent = originalDecodedContent.substring(0, 2000);
            
            const titleEsc = (zhTitle || originalDecodedTitle).replace(/"/g, '\\"');
            const excerptBase = (zhContent || cleanContent).replace(/"/g, '\\"').substring(0, 200);
            
            const markdownContent = '---\n' +
              'layout: post\n' +
              'title: "' + titleEsc + '"\n' +
              'date: ' + date.toISOString().replace('T', ' ').replace(/\.\d{3}Z/, ' +0700') + '\n' +
              'category: ' + category + '\n' +
              'tags: ' + JSON.stringify(tags) + '\n' +
              'source_url: "' + item.link + '"\n' +
              'author: "seacall Team"\n' +
              'excerpt: "' + excerptBase + '..."\n' +
              'featured: false\n' +
              'keywords: "' + tags.join(', ') + '"\n' +
              'lang: vi\n' +
              (zhContent ? 'translated: true\ntranslated_lang: zh-Hans\n' : 'translated: false\n') +
              '---\n\n' +
              (zhContent ? '## ä¸­æ–‡è¯‘æ–‡\n\n' + zhContent + '\n\n---\n\n' : '') +
              '## åŸæ–‡ï¼ˆè¶Šå—è¯­ï¼‰\n\n' + cleanContent + '\n\n' +
              '## ç›¸å…³ä¿¡æ¯\n\n' +
              '- **åŸæ–‡é“¾æ¥**ï¼š[æŸ¥çœ‹å®Œæ•´æ–°é—»](' + item.link + ')\n' +
              '- **æ–°é—»æ¥æº**ï¼š' + feedSource + '\n' +
              '- **å‘å¸ƒæ—¶é—´**ï¼š' + new Date(item.pubDate || date).toLocaleDateString('zh-CN') + '\n\n' +
              '*æƒ³è¦è·å–æ›´ä¸“ä¸šçš„æŠ•èµ„åˆ†æå’Œå»ºè®®ï¼Ÿæ¬¢è¿ä½“éªŒ seacall AI æŠ•èµ„é¡¾é—®æœåŠ¡ã€‚*';
            
            return { filename, content: markdownContent };
          }
          
          async function collectNews() {
            console.log('å¼€å§‹é‡‡é›†RSSæ–°é—»...');
            let totalCollected = 0;
            let totalSkipped = 0;
            
            for (const feed of feeds) {
              try {
                console.log(`æ­£åœ¨é‡‡é›†: ${feed.url} (${feed.source})`);
                const parsed = await parser.parseURL(feed.url);
                console.log(`æˆåŠŸè·å–RSSæº: ${feed.url}, æ–‡ç« æ•°é‡: ${parsed.items.length}`);
                
                // å¢åŠ åˆ°æ¯ä¸ªæºæœ€å¤šå–5ç¯‡
                const items = parsed.items.slice(0, 5);
                let feedCollected = 0;
                let feedSkipped = 0;
                
                for (const item of items) {
                  try {
                    // è§£ç HTMLå®ä½“
                    const decodedTitle = decode(item.title || '');
                    const rawTextWithEntities = (item['content:encoded'] || item.content || item.contentSnippet || '').replace(/<[^>]*>/g, ' ');
                    const decodedRawText = decode(rawTextWithEntities);

                    // æ£€æŸ¥æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
                    if (isInvestmentRelated(decodedTitle, decodedRawText)) {
                      let zhTitle = null, zhContent = null;
                      
                      // ä½¿ç”¨é€šä¹‰åƒé—®ç¿»è¯‘
                      console.log(`ğŸ”„ æ­£åœ¨ä½¿ç”¨ Qwen ç¿»è¯‘: ${decodedTitle.substring(0, 30)}...`);
                      zhTitle = await translateTextWithQwen(decodedTitle);
                      const viContentForTrans = decodedRawText.substring(0, 1500);
                      zhContent = await translateTextWithQwen(viContentForTrans);
                      
                      if (zhTitle) console.log(`âœ… æ ‡é¢˜ç¿»è¯‘å®Œæˆ`);
                      if (zhContent) console.log(`âœ… å†…å®¹ç¿»è¯‘å®Œæˆ`);
                      
                      const { filename, content } = generateMarkdownContent(item, feed.source, feed.category, zhTitle, zhContent, decodedTitle, decodedRawText);
                      const filePath = path.join('_posts', filename);
                      
                      // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                      if (!fs.existsSync(filePath)) {
                        fs.writeFileSync(filePath, content, 'utf8');
                        console.log(`âœ… å·²åˆ›å»º: ${filename}`);
                        feedCollected++;
                        totalCollected++;
                      } else {
                        console.log(`â„¹ï¸ å·²å­˜åœ¨: ${filename}`);
                        feedSkipped++;
                        totalSkipped++;
                      }
                    } else {
                      console.log(`â­ï¸ è·³è¿‡ä¸ç›¸å…³æ–‡ç« : ${item.title.substring(0, 50)}...`);
                      feedSkipped++;
                      totalSkipped++;
                    }
                  } catch (itemError) {
                    console.error(`âŒ å¤„ç†æ–‡ç« æ—¶å‡ºé”™: ${item.title}`, itemError.message);
                    feedSkipped++;
                    totalSkipped++;
                  }
                }
                
                console.log(`ğŸ“Š ${feed.source} é‡‡é›†å®Œæˆ: æ–°å¢ ${feedCollected} ç¯‡, è·³è¿‡ ${feedSkipped} ç¯‡`);
              } catch (error) {
                console.error(`âŒ é‡‡é›† ${feed.url} æ—¶å‡ºé”™:`, error.message);
              }
            }
            
            console.log(`ğŸ‰ RSSé‡‡é›†å®Œæˆ: æ€»è®¡æ–°å¢ ${totalCollected} ç¯‡, è·³è¿‡ ${totalSkipped} ç¯‡`);
          }
          
          collectNews().catch(console.error);
          EOF
          
          node collect-rss.js

      - name: Commit new posts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _posts/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto: Add RSS news posts [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æ–°æ–‡ç« å·²è‡ªåŠ¨å‘å¸ƒ"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ–‡ç« éœ€è¦å‘å¸ƒ"
          fi

      - name: Create summary
        run: |
          echo "## RSS Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Executed at (UTC): $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- New posts: $(git diff HEAD~1 --name-only --diff-filter=A | grep '^_posts/' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Site: https://news.seacall.com" >> $GITHUB_STEP_SUMMARY