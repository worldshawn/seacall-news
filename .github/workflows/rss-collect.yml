name: Auto Collect RSS News

on:
  # 每8小时运行一次
  schedule:
    - cron: '0 */8 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install rss-parser

      - name: Collect RSS feeds
        run: |
          cat > collect-rss.js << 'EOF'
          const Parser = require('rss-parser');
          const fs = require('fs');
          const path = require('path');
          
          const parser = new Parser({
            customFields: {
              item: ['content:encoded', 'content']
            }
          });
          
          // RSS源配置
          const feeds = [
            {
              url: 'https://thanhnien.vn/rss/kinh-te.rss',
              source: 'Thanh Nien Kinh Te',
              category: 'market-analysis'
            },
            {
              url: 'https://tuoitre.vn/rss/kinh-doanh.rss', // 使用Tuoi Tre的商业版块
              source: 'Tuoi Tre Kinh Doanh',
              category: 'investment-news'
            },
            {
              url: 'https://vietnamnet.vn/kinh-doanh.rss', // 修复重定向问题
              source: 'VietnamNet',
              category: 'industry-insights'
            },
            {
              url: 'https://thanhnien.vn/rss/chinh-tri.rss', // 更改为政治类别以获取政策相关内容
              source: 'Thanh Nien Chinh Tri',
              category: 'vietnam-policy'
            }
          ];
          
          // 越南投资相关关键词 - 扩展并优化关键词列表
          const keywords = [
            // 国家和语言
            'vietnam', 'việt nam', 'vietnamese', 'hanoi', 'ho chi minh', 'saigon', 'hochiminh',
            
            // 投资相关
            'investment', 'invest', 'investor', 'investing', 'capital', 'funding', 'venture',
            'đầu tư', 'vốn', 'tài chính', 'tín dụng', 'cho vay', 'dự án',
            
            // 经济和市场
            'economy', 'economic', 'economist', 'kinh tế', 'kinh te', 'gdp', 'inflation', 'growth',
            'market', 'thị trường', 'thi truong', 'stock', 'equity', 'trading', 'trade',
            'business', 'doanh nghiệp', 'doanh nghiep', 'company', 'corporate',
            
            // 政策和法规
            'policy', 'policies', 'regulation', 'regulatory', 'law', 'legal', 'chính sách', 'chinh sach',
            'government', 'governmental', 'state', 'federal', 'central bank', 'ngân hàng', 'ngan hang',
            'monetary', 'fiscal', 'tax', 'thuế', 'thue',
            
            // 行业特定
            'bank', 'banking', 'ngân hàng', 'ngan hang', 'finance', 'financial',
            'real estate', 'bất động sản', 'bat dong san', 'property', 'housing',
            'technology', 'công nghệ', 'cong nghe', 'tech', 'startup', 'innovation',
            'manufacturing', 'manufacture', 'sản xuất', 'san xuat',
            'export', 'xuất khẩu', 'xuat khau', 'import', 'nhập khẩu', 'nhap khau',
            'tourism', 'du lịch', 'du lich', 'hospitality',
            'agriculture', 'nông nghiệp', 'nong nghiep', 'farming',
            
            // 特定术语
            'FDI', 'foreign direct investment', 'OECD', 'ASEAN', 'APEC', 'TPP', 'RCEP',
            'exchange rate', 'currency', 'dong', 'VNĐ', 'VND',
            'stock exchange', 'stock market', 'HOSE', 'HNX', 'UPCOM'
          ];
          
          // 检查文章是否与投资相关
          function isInvestmentRelated(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            return keywords.some(keyword => text.includes(keyword.toLowerCase()));
          }
          
          // 生成文章slug
          function generateSlug(title) {
            return title
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/[\s_-]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 50);
          }
          
          // 获取分类标签
          function getCategoryTags(category) {
            const tagMap = {
              'vietnam-policy': ['vietnam', 'policy', 'government', 'regulation'],
              'market-analysis': ['market', 'analysis', 'economy', 'trend'],
              'investment-news': ['investment', 'finance', 'funding', 'capital'],
              'industry-insights': ['industry', 'business', 'innovation', 'growth']
            };
            return tagMap[category] || ['vietnam', 'news'];
          }
          
          // 生成Markdown内容
          function generateMarkdownContent(item, feedSource, category) {
            const date = new Date();
            const slug = generateSlug(item.title);
            const timePart = `${String(date.getHours()).padStart(2,'0')}${String(date.getMinutes()).padStart(2,'0')}${String(date.getSeconds()).padStart(2,'0')}`;
            const filename = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}-${timePart}-${slug}.md`;
            
            const tags = getCategoryTags(category);
            const content = item['content:encoded'] || item.content || item.contentSnippet || '';
            const cleanContent = content.replace(/<[^>]*>/g, '').substring(0, 500);
            
            const markdownContent = `---
layout: post
title: "${item.title.replace(/"/g, '\\"')}"
date: ${date.toISOString().replace('T', ' ').replace(/\.\d{3}Z/, ' +0700')}
category: ${category}
tags: ${JSON.stringify(tags)}
source_url: "${item.link}"
author: "seacall Team"
excerpt: "${cleanContent.replace(/"/g, '\\"')}..."
featured: false
keywords: "${tags.join(', ')}"
---

## 新闻摘要

${cleanContent}

## 投资角度分析

### 📊 市场影响
根据这一新闻，可能对相关市场产生以下影响：
- **短期影响**：市场情绪变化，相关股票波动
- **中期影响**：行业政策调整，投资机会涌现
- **长期影响**：结构性变化，产业格局重塑

### 💡 投资机会
基于新闻内容，我们识别出以下潜在投资机会：
- **直接机会**：相关上市公司、行业龙头
- **间接机会**：供应链企业、配套服务商
- **新兴机会**：技术创新、商业模式变化

### ⚠️ 风险提示
投资者需要注意的风险因素：
- **政策风险**：政府政策变化的不确定性
- **市场风险**：市场波动和竞争加剧
- **操作风险**：投资时机和规模控制

## 相关资源

- **原文链接**：[查看完整新闻](${item.link})
- **新闻来源**：${feedSource}
- **发布时间**：${new Date(item.pubDate || date).toLocaleDateString('zh-CN')}

> **投资建议**：以上分析仅供参考，投资决策需要综合考虑个人风险承受能力和投资目标。建议咨询专业投资顾问。

*想要获取更专业的投资分析和建议？点击下方按钮体验seacall AI投资顾问服务。*
`;
            
            return { filename, content: markdownContent };
          }
          
          async function collectNews() {
            console.log('开始采集RSS新闻...');
            let totalCollected = 0;
            let totalSkipped = 0;
            
            for (const feed of feeds) {
              try {
                console.log(`正在采集: ${feed.url} (${feed.source})`);
                const parsed = await parser.parseURL(feed.url);
                console.log(`成功获取RSS源: ${feed.url}, 文章数量: ${parsed.items.length}`);
                
                // 增加到每个源最多取5篇
                const items = parsed.items.slice(0, 5);
                let feedCollected = 0;
                let feedSkipped = 0;
                
                for (const item of items) {
                  try {
                    // 检查是否与投资相关
                    if (isInvestmentRelated(item.title, item['content:encoded'] || item.content || item.contentSnippet || '')) {
                      const { filename, content } = generateMarkdownContent(item, feed.source, feed.category);
                      const filePath = path.join('_posts', filename);
                      
                      // 检查文件是否已存在
                      if (!fs.existsSync(filePath)) {
                        fs.writeFileSync(filePath, content, 'utf8');
                        console.log(`✅ 已创建: ${filename}`);
                        feedCollected++;
                        totalCollected++;
                      } else {
                        console.log(`ℹ️ 已存在: ${filename}`);
                        feedSkipped++;
                        totalSkipped++;
                      }
                    } else {
                      console.log(`⏭️ 跳过不相关文章: ${item.title.substring(0, 50)}...`);
                      feedSkipped++;
                      totalSkipped++;
                    }
                  } catch (itemError) {
                    console.error(`❌ 处理文章时出错: ${item.title}`, itemError.message);
                    feedSkipped++;
                    totalSkipped++;
                  }
                }
                
                console.log(`📊 ${feed.source} 采集完成: 新增 ${feedCollected} 篇, 跳过 ${feedSkipped} 篇`);
              } catch (error) {
                console.error(`❌ 采集 ${feed.url} 时出错:`, error.message);
              }
            }
            
            console.log(`🎉 RSS采集完成: 总计新增 ${totalCollected} 篇, 跳过 ${totalSkipped} 篇`);
          }
          
          collectNews().catch(console.error);
          EOF
          
          node collect-rss.js

      - name: Commit new posts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _posts/
          if ! git diff --staged --quiet; then
            git commit -m "🤖 Auto: Add RSS news posts [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "✅ 新文章已自动发布"
          else
            echo "ℹ️ 没有新文章需要发布"
          fi

      - name: Create summary
        run: |
          echo "## RSS Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Executed at (UTC): $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- New posts: $(git diff HEAD~1 --name-only --diff-filter=A | grep '^_posts/' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Site: https://news.seacall.com" >> $GITHUB_STEP_SUMMARY