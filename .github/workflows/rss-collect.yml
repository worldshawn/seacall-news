name: Auto Collect RSS News

on:
  # æ¯8å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */8 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install rss-parser openai

      - name: Collect RSS feeds
        run: |
          cat > collect-rss.js << 'EOF'
          const Parser = require('rss-parser');
          const fs = require('fs');
          const path = require('path');
          
          const parser = new Parser({
            customFields: {
              item: ['content:encoded', 'content']
            }
          });
          
          // RSSæºé…ç½®
          const feeds = [
            {
              url: 'https://vneconomy.vn/rss/home.rss',
              source: 'VnEconomy',
              category: 'market-analysis'
            },
            {
              url: 'https://cafef.vn/rss/trang-chu.rss',
              source: 'CafeF',
              category: 'investment-news'
            },
            {
              url: 'https://vietnamnet.vn/rss/kinh-doanh.rss',
              source: 'VietnamNet',
              category: 'industry-insights'
            }
          ];
          
          // è¶Šå—æŠ•èµ„ç›¸å…³å…³é”®è¯
          const keywords = [
            'vietnam', 'viá»‡t nam', 'investment', 'Ä‘áº§u tÆ°', 'kinh táº¿', 'economy',
            'thá»‹ trÆ°á»ng', 'market', 'chÃ­nh sÃ¡ch', 'policy', 'ngÃ¢n hÃ ng', 'bank',
            'báº¥t Ä‘á»™ng sáº£n', 'real estate', 'cÃ´ng nghá»‡', 'technology', 'startup',
            'FDI', 'GDP', 'xuáº¥t kháº©u', 'export', 'nháº­p kháº©u', 'import'
          ];
          
          // æ£€æŸ¥æ–‡ç« æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
          function isInvestmentRelated(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            return keywords.some(keyword => text.includes(keyword.toLowerCase()));
          }
          
          // ç”Ÿæˆæ–‡ç« slug
          function generateSlug(title) {
            return title
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/[\s_-]+/g, '-')
              .replace(/^-+|-+$/g, '')
              .substring(0, 50);
          }
          
          // è·å–åˆ†ç±»æ ‡ç­¾
          function getCategoryTags(category) {
            const tagMap = {
              'vietnam-policy': ['vietnam', 'policy', 'government', 'regulation'],
              'market-analysis': ['market', 'analysis', 'economy', 'trend'],
              'investment-news': ['investment', 'finance', 'funding', 'capital'],
              'industry-insights': ['industry', 'business', 'innovation', 'growth']
            };
            return tagMap[category] || ['vietnam', 'news'];
          }
          
          // ç”ŸæˆMarkdownå†…å®¹
          function generateMarkdownContent(item, feedSource, category) {
            const date = new Date();
            const slug = generateSlug(item.title);
            const filename = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}-${slug}.md`;
            
            const tags = getCategoryTags(category);
            const content = item['content:encoded'] || item.content || item.contentSnippet || '';
            const cleanContent = content.replace(/<[^>]*>/g, '').substring(0, 500);
            
            const markdownContent = `---
layout: post
title: "${item.title.replace(/"/g, '\\"')}"
date: ${date.toISOString().replace('T', ' ').replace(/\.\d{3}Z/, ' +0700')}
category: ${category}
tags: ${JSON.stringify(tags)}
source_url: "${item.link}"
author: "seacall Team"
excerpt: "${cleanContent.replace(/"/g, '\\"')}..."
featured: false
keywords: "${tags.join(', ')}"
---

## æ–°é—»æ‘˜è¦

${cleanContent}

## æŠ•èµ„è§’åº¦åˆ†æ

### ğŸ“Š å¸‚åœºå½±å“
æ ¹æ®è¿™ä¸€æ–°é—»ï¼Œå¯èƒ½å¯¹ç›¸å…³å¸‚åœºäº§ç”Ÿä»¥ä¸‹å½±å“ï¼š
- **çŸ­æœŸå½±å“**ï¼šå¸‚åœºæƒ…ç»ªå˜åŒ–ï¼Œç›¸å…³è‚¡ç¥¨æ³¢åŠ¨
- **ä¸­æœŸå½±å“**ï¼šè¡Œä¸šæ”¿ç­–è°ƒæ•´ï¼ŒæŠ•èµ„æœºä¼šæ¶Œç°
- **é•¿æœŸå½±å“**ï¼šç»“æ„æ€§å˜åŒ–ï¼Œäº§ä¸šæ ¼å±€é‡å¡‘

### ğŸ’¡ æŠ•èµ„æœºä¼š
åŸºäºæ–°é—»å†…å®¹ï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºä»¥ä¸‹æ½œåœ¨æŠ•èµ„æœºä¼šï¼š
- **ç›´æ¥æœºä¼š**ï¼šç›¸å…³ä¸Šå¸‚å…¬å¸ã€è¡Œä¸šé¾™å¤´
- **é—´æ¥æœºä¼š**ï¼šä¾›åº”é“¾ä¼ä¸šã€é…å¥—æœåŠ¡å•†
- **æ–°å…´æœºä¼š**ï¼šæŠ€æœ¯åˆ›æ–°ã€å•†ä¸šæ¨¡å¼å˜åŒ–

### âš ï¸ é£é™©æç¤º
æŠ•èµ„è€…éœ€è¦æ³¨æ„çš„é£é™©å› ç´ ï¼š
- **æ”¿ç­–é£é™©**ï¼šæ”¿åºœæ”¿ç­–å˜åŒ–çš„ä¸ç¡®å®šæ€§
- **å¸‚åœºé£é™©**ï¼šå¸‚åœºæ³¢åŠ¨å’Œç«äº‰åŠ å‰§
- **æ“ä½œé£é™©**ï¼šæŠ•èµ„æ—¶æœºå’Œè§„æ¨¡æ§åˆ¶

## ç›¸å…³èµ„æº

- **åŸæ–‡é“¾æ¥**ï¼š[æŸ¥çœ‹å®Œæ•´æ–°é—»](${item.link})
- **æ–°é—»æ¥æº**ï¼š${feedSource}
- **å‘å¸ƒæ—¶é—´**ï¼š${new Date(item.pubDate || date).toLocaleDateString('zh-CN')}

> **æŠ•èµ„å»ºè®®**ï¼šä»¥ä¸Šåˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„å†³ç­–éœ€è¦ç»¼åˆè€ƒè™‘ä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›å’ŒæŠ•èµ„ç›®æ ‡ã€‚å»ºè®®å’¨è¯¢ä¸“ä¸šæŠ•èµ„é¡¾é—®ã€‚

*æƒ³è¦è·å–æ›´ä¸“ä¸šçš„æŠ•èµ„åˆ†æå’Œå»ºè®®ï¼Ÿç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä½“éªŒseacall AIæŠ•èµ„é¡¾é—®æœåŠ¡ã€‚*
`;
            
            return { filename, content: markdownContent };
          }
          
          async function collectNews() {
            console.log('å¼€å§‹é‡‡é›†RSSæ–°é—»...');
            
            for (const feed of feeds) {
              try {
                console.log(`æ­£åœ¨é‡‡é›†: ${feed.url}`);
                const parsed = await parser.parseURL(feed.url);
                const items = parsed.items.slice(0, 3); // æ¯ä¸ªæºæœ€å¤šå–3ç¯‡
                
                for (const item of items) {
                  // æ£€æŸ¥æ˜¯å¦ä¸æŠ•èµ„ç›¸å…³
                  if (isInvestmentRelated(item.title, item.contentSnippet || '')) {
                    const { filename, content } = generateMarkdownContent(item, feed.source, feed.category);
                    const filePath = path.join('_posts', filename);
                    
                    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                    if (!fs.existsSync(filePath)) {
                      fs.writeFileSync(filePath, content, 'utf8');
                      console.log(`å·²åˆ›å»º: ${filename}`);
                    } else {
                      console.log(`å·²å­˜åœ¨: ${filename}`);
                    }
                  }
                }
              } catch (error) {
                console.error(`é‡‡é›† ${feed.url} æ—¶å‡ºé”™:`, error.message);
              }
            }
            
            console.log('RSSé‡‡é›†å®Œæˆ');
          }
          
          collectNews().catch(console.error);
          EOF
          
          node collect-rss.js

      - name: Commit new posts
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add _posts/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto: Add RSS news posts [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… æ–°æ–‡ç« å·²è‡ªåŠ¨å‘å¸ƒ"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°æ–‡ç« éœ€è¦å‘å¸ƒ"
          fi

      - name: Create summary
        run: |
          echo "## RSSé‡‡é›†æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“… æ‰§è¡Œæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“° é‡‡é›†æº: ${#feeds[@]} ä¸ªRSSæº" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ æ–°å¢æ–‡ç« : $(git diff HEAD~1 --name-only --diff-filter=A | grep '^_posts/' | wc -l) ç¯‡" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— ç«™ç‚¹åœ°å€: [æŸ¥çœ‹ç«™ç‚¹](https://news.seacall.com)" >> $GITHUB_STEP_SUMMARY